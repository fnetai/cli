{# ============================================================================
   WEBHOOK MODE - IMPLEMENTATION
   ============================================================================
   Event-driven HTTP webhook server with HMAC signature verification
   ============================================================================ #}

if (cliMode === 'webhook') {
  const port = args['cli-port'] || args.cli_port || 3000;
  const webhookPath = args['webhook-path'] || args.webhook_path || '/webhook';
  const webhookSecret = args['webhook-secret'] || args.webhook_secret || process.env.WEBHOOK_SECRET;
  const signatureHeader = args['webhook-signature-header'] || args.webhook_signature_header || 'x-hub-signature-256';
  
  const server = http.createServer(async (req, res) => {
    // CORS headers
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, ' + signatureHeader);
    
    // Handle OPTIONS preflight
    if (req.method === 'OPTIONS') {
      res.writeHead(200);
      res.end();
      return;
    }
    
    // Only accept POST requests
    if (req.method !== 'POST') {
      res.writeHead(405, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ error: 'Method not allowed. Use POST.' }));
      return;
    }
    
    // Only accept webhook path
    if (req.url !== webhookPath) {
      res.writeHead(404, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ error: 'Not found. Use ' + webhookPath }));
      return;
    }
    
    // Read request body
    let body = '';
    req.on('data', chunk => {
      body += chunk.toString();
    });
    
    req.on('end', async () => {
      try {
        // Verify signature if secret is provided
        if (webhookSecret) {
          const signature = req.headers[signatureHeader.toLowerCase()];
          
          if (!signature) {
            res.writeHead(401, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: 'Missing signature header: ' + signatureHeader }));
            return;
          }
          
          // Calculate expected signature (HMAC-SHA256)
          const hmac = crypto.createHmac('sha256', webhookSecret);
          hmac.update(body);
          const expectedSignature = 'sha256=' + hmac.digest('hex');
          
          // Compare signatures (timing-safe)
          const signatureBuffer = Buffer.from(signature);
          const expectedBuffer = Buffer.from(expectedSignature);
          
          if (signatureBuffer.length !== expectedBuffer.length || 
              !crypto.timingSafeEqual(signatureBuffer, expectedBuffer)) {
            res.writeHead(401, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: 'Invalid signature' }));
            return;
          }
        }
        
        // Parse JSON payload
        let payload;
        try {
          payload = JSON.parse(body);
        } catch (e) {
          res.writeHead(400, { 'Content-Type': 'application/json' });
          res.end(JSON.stringify({ error: 'Invalid JSON payload' }));
          return;
        }
        
        // Process webhook with Core
        const result = await Node(payload);
        
        // Send response
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify(result));
        
      } catch (error) {
        res.writeHead(500, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ 
          error: error.message,
          type: 'processing_error'
        }));
      }
    });
    
    req.on('error', (error) => {
      res.writeHead(500, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ 
        error: error.message,
        type: 'request_error'
      }));
    });
  });
  
  server.listen(port, () => {
    console.log(`Webhook server started on port ${port}`);
    console.log(`Webhook endpoint: ${webhookPath}`);
    if (webhookSecret) {
      console.log(`Signature verification: enabled (header: ${signatureHeader})`);
    } else {
      console.log(`Signature verification: disabled (no secret provided)`);
    }
  });
  
  return;
}

