name: cli

# @fnet/shell-flow commands
commands:
  build:
    - bun run build
    - bun ./dist/fnode/index.js --version
    - bun ./dist/fnet/index.js --version
    - bun ./dist/frun/index.js --version
    - bun ./dist/fbin/index.js --version
    - bun link

  deploy:
    - fnet build
    - bun publish --access public

  compile-frun:
    - bun build ./dist/frun/index.js --compile --outfile=.bin/frun
    - du -h .bin/frun
    - chmod +x .bin/frun
    - .bin/frun --help
    - otool -L .bin/frun

  compile-fbin:
    - bun build ./dist/fbin/index.js --compile --outfile=.bin/fbin
    - du -h .bin/fbin
    - chmod +x .bin/fbin
    - .bin/fbin --help
    - otool -L .bin/fbin

  compile-fnode:
    - bun build ./dist/fnode/index.js --compile --outfile=.bin/fnode
    - du -h .bin/fnode
    - chmod +x .bin/fnode
    - .bin/fnode --help
    - otool -L .bin/fnode

  compile-fnet:
    - bun build ./dist/fnet/index.js --compile --outfile=.bin/fnet
    - du -h .bin/fnet
    - chmod +x .bin/fnet
    - .bin/fnet --help
    - otool -L .bin/fnet

  compile:
    steps:
      - frun build
      - pause: true

      - frun compile-fbin
      - pause: true

      - frun compile-frun
      - pause: true

      - frun compile-fnode
      - pause: true

      - frun compile-fnet
      - pause: true

  create-fnode-node:
    - rm -rf .tests/fnode-node
    - wdir: .tests
      steps:
        - fnode create --name fnode-node --runtime node
        - wdir: .tests/fnode-node
          steps:
            # - fnode build
            - fnode cli

  create-fnet-node:
    - rm -rf .tests/fnet-node
    - wdir: .tests
      steps:
        - fnet create --name fnet-node --runtime node
        - wdir: .tests/fnet-node
          steps:
            # - fnet build
            - fnet cli

  create-fnode-python:
    - rm -rf .tests/fnode-python
    - wdir: .tests
      steps:
        - fnode create --name fnode-python --runtime python
        - wdir: .tests/fnode-python
          steps:
            # - fnode build
            - fnode cli

  create-fnode-bun:
    - rm -rf .tests/fnode-bun
    - wdir: .tests
      steps:
        - fnode create --name fnode-bun --runtime bun
        - wdir: .tests/fnode-bun
          steps:
            # - fnode build
            - fnode cli

  create-all:
    - xfrun create-fnode-node
    - xfrun create-fnet-node
    - xfrun create-fnode-python
    - xfrun create-fnode-bun

  test-examples:
    - wdir: examples/fnode/node-1
      steps:
        - fnode build
        - fnode cli
    - wdir: examples/fnode/python-1
      steps:
        - fnode build
        - fnode cli
    - wdir: examples/fnode/bun-1
      steps:
        - fnode build
        - fnode cli
    - wdir: examples/fnet/node-1
      steps:
        - fnet build
        - fnet cli

  # Bin system utility commands
  bin-setup:
    - fbin setup

  bin-path:
    - fbin path

  bin-status:
    - echo "Checking bin system status..."
    - ls -la ~/.fnet/bin
    - echo "Metadata file:"
    - cat ~/.fnet/metadata/binaries.json
    - echo "Checking if bin directory is in PATH..."
    - echo $PATH | grep -q ~/.fnet/bin && echo "Bin directory is in PATH" || echo "Bin directory is NOT in PATH"

  # Test commands for Phase 2
  test-fnode-compile:
    - rm -rf .tests/fnode-node-compile
    - wdir: .tests
      steps:
        - fnode create --name fnode-node-compile --runtime node
        - wdir: .tests/fnode-node-compile
          steps:
            - filemap:
                target: "src"
                sources:
                  - source: |
                      export default async (args) => {
                        console.log("Hello from fnode-node-compile project!");
                        return "Success!";
                      }
                    provider: text
                    target: "index.js"
            - fnode build
            - fnode compile
            - wdir: .tests/fnode-node-compile/.workspace
              steps:
                - pwd
                - ls -la .bin
                - ./.bin/fnode-node-compile

  test-fnet-compile:
    - rm -rf .tests/fnet-node-compile
    - wdir: .tests
      steps:
        - fnet create --name fnet-node-compile --runtime node
        - wdir: .tests/fnet-node-compile
          steps:
            - filemap:
                target: "./"
                sources:
                  - source: |
                      main:
                        steps:
                          - hello-world:    
                              call: hello-step
                    provider: text
                    target: "fnet/flows.yaml"
                  - source: |
                      export default async (args) => {
                        console.log("Hello from fnet-node-compile project!");
                        return "Success!";
                      }
                    provider: text
                    target: "src/hello-step.js"
            - fnet build
            - fnet compile
            - wdir: .tests/fnet-node-compile/.workspace
              steps:
                - pwd
                - ls -la .bin
                - ./.bin/fnet-node-compile

  test-compile-all:
    - frun test-fnode-compile
    - frun test-fnet-compile
